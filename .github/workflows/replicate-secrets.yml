name: Replicate Secrets Manager
run-name: Replicate Secrets (${{ inputs.env }}, ${{ inputs.source_region }} -> ${{ inputs.target_regions }})

on:
  workflow_dispatch:
    inputs:
      env:
        description: Environment
        required: true
        default: dev
        type: choice
        options:
          - dev
          - qa
          - stg
          - perf
          - prod
      source_region:
        description: Source AWS region
        required: true
        default: us-east-1
      target_regions:
        description: Comma-separated target regions
        required: true
        default: eu-west-1,ap-southeast-1
      secret_names:
        description: Optional comma-separated full secret names (overrides defaults)
        required: false

jobs:
  replicate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    steps:
      - name: Validate ROLE_ARN secret
        env:
          ROLE_ARN: ${{ secrets.ROLE_ARN }}
        run: |
          if [ -z "$ROLE_ARN" ]; then
            echo "ROLE_ARN secret is empty or not set for this environment."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ inputs.source_region }}
          role-session-name: replicate-secrets-${{ inputs.env }}

      - name: Replicate secrets to target regions
        env:
          APP_PREFIX: ${{ secrets.APP_PREFIX }}
          ENV_NAME: ${{ inputs.env }}
          SOURCE_REGION: ${{ inputs.source_region }}
          TARGET_REGIONS: ${{ inputs.target_regions }}
          SECRET_NAMES: ${{ inputs.secret_names }}
        run: |
          set -euo pipefail

          if [ -z "$APP_PREFIX" ]; then
            echo "APP_PREFIX secret is empty or not set for this environment."
            exit 1
          fi

          IFS=',' read -r -a TARGET_REGION_LIST <<< "$TARGET_REGIONS"

          declare -a SECRETS=()
          if [ -n "${SECRET_NAMES:-}" ]; then
            IFS=',' read -r -a SECRETS <<< "$SECRET_NAMES"
          else
            aws secretsmanager list-secrets \
              --region "$SOURCE_REGION" \
              --output json > /tmp/secret_list.json

            python3 -c 'import json, pathlib; data=json.load(open("/tmp/secret_list.json")); names=[item.get("Name") for item in data.get("SecretList", []) if not item.get("DeletedDate") and item.get("Name")]; pathlib.Path("/tmp/secret_list.txt").write_text("\n".join(names))'

            mapfile -t SECRETS < /tmp/secret_list.txt
          fi

          for secret_id in "${SECRETS[@]}"; do
            secret_id="$(echo "$secret_id" | xargs)"
            if [ -z "$secret_id" ]; then
              continue
            fi

            echo "Replicating ${secret_id} from ${SOURCE_REGION}"
            aws secretsmanager get-secret-value \
              --region "$SOURCE_REGION" \
              --secret-id "$secret_id" \
              --output json > /tmp/secret_value.json

            aws secretsmanager describe-secret \
              --region "$SOURCE_REGION" \
              --secret-id "$secret_id" \
              --output json > /tmp/secret_desc.json

            python3 -c 'import base64, json, pathlib; value=json.load(open("/tmp/secret_value.json")); secret_string=value.get("SecretString"); secret_binary=value.get("SecretBinary");\nif secret_string is not None:\n    pathlib.Path("/tmp/secret_type").write_text("string"); pathlib.Path("/tmp/secret_payload").write_text(secret_string)\nelif secret_binary is not None:\n    pathlib.Path("/tmp/secret_type").write_text("binary"); pathlib.Path("/tmp/secret_payload_bin").write_bytes(base64.b64decode(secret_binary))\nelse:\n    raise SystemExit("Secret has neither SecretString nor SecretBinary")'

            DESCRIPTION="$(python3 -c 'import json; desc=json.load(open("/tmp/secret_desc.json")); print(desc.get("Description", ""))')"

            for region in "${TARGET_REGION_LIST[@]}"; do
              region="$(echo "$region" | xargs)"
              if [ -z "$region" ] || [ "$region" = "$SOURCE_REGION" ]; then
                continue
              fi

              echo " -> ${region}"
              if aws secretsmanager describe-secret --region "$region" --secret-id "$secret_id" >/dev/null 2>&1; then
                if [ "$(cat /tmp/secret_type)" = "string" ]; then
                  aws secretsmanager put-secret-value \
                    --region "$region" \
                    --secret-id "$secret_id" \
                    --secret-string file:///tmp/secret_payload
                else
                  aws secretsmanager put-secret-value \
                    --region "$region" \
                    --secret-id "$secret_id" \
                    --secret-binary fileb:///tmp/secret_payload_bin
                fi
              else
                if [ "$(cat /tmp/secret_type)" = "string" ]; then
                  aws secretsmanager create-secret \
                    --region "$region" \
                    --name "$secret_id" \
                    --description "$DESCRIPTION" \
                    --secret-string file:///tmp/secret_payload
                else
                  aws secretsmanager create-secret \
                    --region "$region" \
                    --name "$secret_id" \
                    --description "$DESCRIPTION" \
                    --secret-binary fileb:///tmp/secret_payload_bin
                fi
              fi
            done
          done
