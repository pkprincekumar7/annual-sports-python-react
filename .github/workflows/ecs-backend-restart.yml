name: ECS Backend Restart
run-name: ECS Backend Restart (${{ inputs.env }}, ${{ inputs.aws_region }}, ${{ inputs.service }})

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment (dev, qa, stg, perf, prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - stg
          - perf
          - prod
      aws_region:
        description: "AWS region"
        required: true
        default: "us-east-1"
        type: choice
        options:
          - us-east-1
          - eu-west-1
          - ap-southeast-1
      role_arn:
        description: "AWS IAM role to assume via OIDC"
        required: true
      service:
        description: "Service to restart"
        required: true
        default: "identity-service"
        type: choice
        options:
          - identity-service
          - enrollment-service
          - department-service
          - sports-part-service
          - event-config-service
          - scheduling-service
          - scoring-service
          - reporting-service

permissions:
  id-token: write
  contents: read

concurrency:
  group: ecs-backend-restart-${{ inputs.env }}-${{ inputs.aws_region }}-${{ inputs.service }}
  cancel-in-progress: false

env:
  APP_PREFIX: "as"

jobs:
  restart:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Restart ECS services
        env:
          AWS_REGION: ${{ inputs.aws_region }}
          SERVICE: ${{ inputs.service }}
        run: |
          NAME_PREFIX="${APP_PREFIX}-${{ inputs.env }}"
          CLUSTER_NAME="${APP_PREFIX}-${{ inputs.env }}-cluster"
          svc="${NAME_PREFIX}-${SERVICE}"
          aws ecs update-service --cluster "$CLUSTER_NAME" --service "$svc" --force-new-deployment
          aws ecs wait services-stable --cluster "$CLUSTER_NAME" --services "${svc}"
