name: ECS Backend Deploy
run-name: ECS Backend Deploy (${{ inputs.env }}, ${{ inputs.aws_region }}, ${{ inputs.service }})

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment (dev, qa, stg, perf, prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - stg
          - perf
          - prod
      aws_region:
        description: "AWS region"
        required: true
        default: "us-east-1"
        type: choice
        options:
          - us-east-1
          - eu-west-1
          - ap-southeast-1
      service:
        description: "Service to deploy"
        required: true
        default: "identity-service"
        type: choice
        options:
          - identity-service
          - enrollment-service
          - department-service
          - sports-part-service
          - event-config-service
          - scheduling-service
          - scoring-service
          - reporting-service

permissions:
  id-token: write
  contents: read

concurrency:
  group: ecs-backend-deploy-${{ inputs.env }}-${{ inputs.aws_region }}-${{ inputs.service }}
  cancel-in-progress: false

jobs:
  build_push:
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    outputs:
      name_prefix: ${{ steps.vars.outputs.name_prefix }}
      cluster_name: ${{ steps.vars.outputs.cluster_name }}
      image_tag: ${{ steps.vars.outputs.image_tag }}
      service: ${{ steps.vars.outputs.service }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate ROLE_ARN secret
        env:
          ROLE_ARN: ${{ secrets.ROLE_ARN }}
          APP_PREFIX: ${{ secrets.APP_PREFIX }}
        run: |
          if [ -z "$ROLE_ARN" ]; then
            echo "ROLE_ARN secret is empty or not set for this environment."
            exit 1
          fi
          if [ -z "$APP_PREFIX" ]; then
            echo "APP_PREFIX secret is empty or not set for this environment."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Resolve variables
        id: vars
        env:
          APP_PREFIX: ${{ secrets.APP_PREFIX }}
        run: |
          NAME_PREFIX="${APP_PREFIX}-${{ inputs.env }}"
          CLUSTER_NAME="${APP_PREFIX}-${{ inputs.env }}-cluster"
          IMAGE_TAG=$(date -u +"%Y%m%d%H%M%S")
          echo "name_prefix=$NAME_PREFIX" >> "$GITHUB_OUTPUT"
          echo "cluster_name=$CLUSTER_NAME" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "service=${{ inputs.service }}" >> "$GITHUB_OUTPUT"

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push images
        env:
          AWS_REGION: ${{ inputs.aws_region }}
          IMAGE_TAG: ${{ steps.vars.outputs.image_tag }}
          NAME_PREFIX: ${{ steps.vars.outputs.name_prefix }}
          SERVICE: ${{ steps.vars.outputs.service }}
        run: |
          set -euo pipefail
          if [ -z "${SERVICE:-}" ] || [[ "$SERVICE" == -* ]]; then
            echo "SERVICE is empty or invalid: '$SERVICE'"
            exit 1
          fi
          if [ -z "${NAME_PREFIX:-}" ]; then
            echo "NAME_PREFIX is empty."
            exit 1
          fi
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REPO_ROOT="$GITHUB_WORKSPACE"
          SERVICE_DIR="$SERVICE"
          case "$SERVICE" in
            sports-part-service) SERVICE_DIR="sports-participation-service" ;;
            event-config-service) SERVICE_DIR="event-configuration-service" ;;
          esac
          docker build -t "${NAME_PREFIX}-${SERVICE}:${IMAGE_TAG}" "$REPO_ROOT/$SERVICE_DIR"
          docker tag "${NAME_PREFIX}-${SERVICE}:${IMAGE_TAG}" \
            "$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/${NAME_PREFIX}-${SERVICE}:${IMAGE_TAG}"
          docker push "$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/${NAME_PREFIX}-${SERVICE}:${IMAGE_TAG}"

  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    needs: build_push
    steps:
      - name: Validate ROLE_ARN secret
        env:
          ROLE_ARN: ${{ secrets.ROLE_ARN }}
          APP_PREFIX: ${{ secrets.APP_PREFIX }}
        run: |
          if [ -z "$ROLE_ARN" ]; then
            echo "ROLE_ARN secret is empty or not set for this environment."
            exit 1
          fi
          if [ -z "$APP_PREFIX" ]; then
            echo "APP_PREFIX secret is empty or not set for this environment."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Register new task definitions and deploy
        env:
          APP_PREFIX: ${{ secrets.APP_PREFIX }}
          ENV_NAME: ${{ inputs.env }}
          IMAGE_TAG: ${{ needs.build_push.outputs.image_tag }}
          AWS_REGION: ${{ inputs.aws_region }}
          SERVICE: ${{ needs.build_push.outputs.service }}
        run: |
          set -euo pipefail
          if [ -z "${APP_PREFIX:-}" ]; then
            echo "APP_PREFIX is empty."
            exit 1
          fi
          if [ -z "${ENV_NAME:-}" ]; then
            echo "ENV_NAME is empty."
            exit 1
          fi
          if [ -z "${SERVICE:-}" ] || [[ "$SERVICE" == -* ]]; then
            echo "SERVICE is empty or invalid: '$SERVICE'"
            exit 1
          fi
          NAME_PREFIX="${APP_PREFIX}-${ENV_NAME}"
          CLUSTER_NAME="${APP_PREFIX}-${ENV_NAME}-cluster"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          IMAGE_PREFIX="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
          svc="${NAME_PREFIX}-${SERVICE}"
          CONTAINER_NAME="$SERVICE"
          TASK_DEF_ARN=$(aws ecs describe-services --cluster "$CLUSTER_NAME" --services "$svc" --query 'services[0].taskDefinition' --output text)
          TASK_DEF_JSON=$(aws ecs describe-task-definition --task-definition "$TASK_DEF_ARN" --query 'taskDefinition')
          NEW_IMAGE="$IMAGE_PREFIX/${NAME_PREFIX}-${SERVICE}:${IMAGE_TAG}"
          NEW_TASK_DEF=$(echo "$TASK_DEF_JSON" | jq --arg name "$CONTAINER_NAME" --arg image "$NEW_IMAGE" '
            .containerDefinitions = (.containerDefinitions | map(if .name == $name then .image = $image else . end)) |
            del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
          ')
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster "$CLUSTER_NAME" --service "$svc" --task-definition "$NEW_TASK_DEF_ARN"

          aws ecs wait services-stable --cluster "$CLUSTER_NAME" --services "${svc}"
