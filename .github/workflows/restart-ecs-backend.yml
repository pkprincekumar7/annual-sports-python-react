name: Restart ECS Backend
run-name: Restart ECS Backend (${{ inputs.env }}, ${{ inputs.aws_region }}, ${{ inputs.service }})

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment (dev, qa, stg, perf, prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - stg
          - perf
          - prod
      aws_region:
        description: "AWS region"
        required: true
        default: "us-east-1"
        type: choice
        options:
          - us-east-1
          - eu-west-1
          - ap-southeast-1
      service:
        description: "Service to restart"
        required: true
        default: "identity-service"
        type: choice
        options:
          - identity-service
          - enrollment-service
          - department-service
          - sports-part-service
          - event-config-service
          - scheduling-service
          - scoring-service
          - reporting-service

permissions:
  id-token: write
  contents: read

concurrency:
  group: restart-ecs-backend-${{ inputs.env }}-${{ inputs.aws_region }}-${{ inputs.service }}
  cancel-in-progress: false

jobs:
  restart:
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    steps:
      - name: Validate ROLE_ARN secret
        env:
          ROLE_ARN: ${{ secrets.ROLE_ARN }}
          APP_PREFIX: ${{ secrets.APP_PREFIX }}
        run: |
          if [ -z "$ROLE_ARN" ]; then
            echo "ROLE_ARN secret is empty or not set for this environment."
            exit 1
          fi
          if [ -z "$APP_PREFIX" ]; then
            echo "APP_PREFIX secret is empty or not set for this environment."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}

      - name: Restart ECS services
        env:
          APP_PREFIX: ${{ secrets.APP_PREFIX }}
          AWS_REGION: ${{ inputs.aws_region }}
          SERVICE: ${{ inputs.service }}
        run: |
          set -euo pipefail
          if [ -z "${SERVICE:-}" ] || [[ "$SERVICE" == -* ]]; then
            echo "SERVICE is empty or invalid: '$SERVICE'"
            exit 1
          fi
          NAME_PREFIX="${APP_PREFIX}-${{ inputs.env }}"
          CLUSTER_NAME="${APP_PREFIX}-${{ inputs.env }}-cluster"
          svc="${NAME_PREFIX}-${SERVICE}"
          aws ecs update-service --cluster "$CLUSTER_NAME" --service "$svc" --force-new-deployment
          aws ecs wait services-stable --cluster "$CLUSTER_NAME" --services "${svc}"
